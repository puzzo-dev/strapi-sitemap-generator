# Strapi Sitemap Generator â€“ Copilot Notes
- Plugin targets Strapi v5; two entry points: admin UI in [admin/src/index.ts](admin/src/index.ts) and server plugin in [server/src/index.ts](server/src/index.ts). Plugin id is `strapi-sitemap-generator` defined in [admin/src/pluginId.ts](admin/src/pluginId.ts).
- Package scripts: `npm run build` (strapi-plugin build), `watch`, `watch:link` for linked dev, `verify` (strapi-plugin verify), and TS checks `test:ts:front`/`test:ts:back` targeting admin/server configs in package.json. Use these instead of ad-hoc builds.
- Exports map to `./strapi-admin` and `./strapi-server` bundles (see package.json `exports`); keep paths/types in sync with dist outputs when adjusting build targets.
- Admin router is trivial: [admin/src/pages/App.tsx](admin/src/pages/App.tsx) mounts [HomePage](admin/src/pages/HomePage.tsx) at root with `Page.Error` fallback. Initialize plugin id via [admin/src/components/Initializer.tsx](admin/src/components/Initializer.tsx).
- UI stack: React 18 + Strapi design-system + `useFetchClient`/`useNotification` from `@strapi/admin/strapi-admin`; no Redux/zustand. Keep new UI in this style and reuse design-system components for consistency.
- Home page behavior: on load it GETs `/strapi-sitemap-generator/content-types` then `/strapi-sitemap-generator/config`, storing selections in a `Set`. Save and generate both PUT config with `baseUrl`, `selectedContentTypes`, and maps `customPaths`/`customPriorities`/`customChangefreq` (see [admin/src/pages/HomePage.tsx](admin/src/pages/HomePage.tsx)).
- Generation flow: after saving, GET `/strapi-sitemap-generator/data` to preview stats; notifications surface success/failure. Preview XML opens `/api/strapi-sitemap-generator/sitemap.xml`. A download helper exists but server intentionally exposes only the public XML endpoint.
- UI assumptions: only content types containing a `slug` are eligible; defaults use `https://example.com`, priority `0.7`, changefreq `monthly`, and base path `/${pluralName}` unless overridden.
- Translations: `registerTrads` loads locale JSONs if present, otherwise returns `{}`; helper [admin/src/utils/getTranslation.ts](admin/src/utils/getTranslation.ts) prefixes ids. Only `en.json` exists, so add new locale files when adding strings.
- Server routes: admin routes in [server/src/routes/admin/index.ts](server/src/routes/admin/index.ts) (GET `/data`, `/content-types`, `/config`; PUT `/config`) and public content-api route [server/src/routes/content-api/index.ts](server/src/routes/content-api/index.ts) for `/sitemap.xml` with `auth: false`.
- Controller layer [server/src/controllers/controller.ts](server/src/controllers/controller.ts) delegates to the single service; keep it thin and wrap failures with `ctx.throw`.
- Service logic [server/src/services/service.ts](server/src/services/service.ts) walks `strapi.contentTypes`, filtering `api::` UIDs that expose a `slug` attribute; marks `hasPublishedAt` when attribute exists.
- Sitemap XML generation: fetch config from plugin store key `config`; iterate only `selectedContentTypes`; for each, `entityService.findMany(uid)` with no filters, build URLs via `normalizeUrlPath(baseUrl, customPath||/${pluralName}, entry.slug)` which handles root paths ("/") and prevents double slashes, default priority/changefreq, and escape XML. Stops early if nothing selected.
- Sitemap preview data: aggregates URLs per UID with title fallback `title || name || slug`, `lastmod` from `updatedAt`, totals URL counts, and stamps `lastGenerated` with current timestamp.
- Config persistence: `getConfig`/`updateConfig` read/write plugin store (`strapi.store({ type: 'plugin', name: 'strapi-sitemap-generator' })`). Initialize missing configs with defaults; keep schema compatible with UI expectations.
- Logging: service uses `strapi.log.info/warn/error` for each step; preserve this style for observability during builds and in production.
- No custom content types, policies, or middlewares are defined (see the empty indexes in [server/src/content-types/index.ts](server/src/content-types/index.ts), [server/src/policies/index.ts](server/src/policies/index.ts), [server/src/middlewares/index.ts](server/src/middlewares/index.ts)); add new ones by extending those exports.
- Plugin lifecycle hooks [server/src/register.ts](server/src/register.ts), [server/src/bootstrap.ts](server/src/bootstrap.ts), [server/src/destroy.ts](server/src/destroy.ts) are stubs; wire new startup/teardown logic here instead of in route handlers.
- Strapi endpoint prefixes: admin requests use `/strapi-sitemap-generator/*`, public sitemap is `/api/strapi-sitemap-generator/sitemap.xml`; match these when adding frontend calls or routes.
- Styling/UX: Home page uses design-system boxes, badges, and selects; keep layouts responsive with `Flex`/`Box` and avoid custom CSS when possible.
- Testing gap: no automated tests; rely on TypeScript `tsconfig` per package and Strapi plugin CLI `verify`. Run both TS checks after changes touching admin/server code.
- When extending sitemap rules, keep slug requirement and XML escaping intact to avoid malformed output. Add configurable filters/pagination carefully since `findMany` currently returns all entries.